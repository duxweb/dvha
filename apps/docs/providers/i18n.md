# å›½é™…åŒ–æä¾›è€…

å›½é™…åŒ–æä¾›è€…æ˜¯ DVHA çš„æ ¸å¿ƒæ¦‚å¿µä¹‹ä¸€ï¼Œå®ƒæ˜¯ä¸€ä¸ªæŠ½è±¡å±‚ï¼Œè´Ÿè´£å¤„ç†åº”ç”¨ç¨‹åºçš„å¤šè¯­è¨€å’Œå›½é™…åŒ–åŠŸèƒ½ã€‚é€šè¿‡å›½é™…åŒ–æä¾›è€…ï¼Œæ‚¨å¯ä»¥è½»æ¾åœ°ä¸ºåº”ç”¨æ·»åŠ å¤šè¯­è¨€æ”¯æŒï¼Œæä¾›ç¿»è¯‘ã€è¯­è¨€åˆ‡æ¢ç­‰åŠŸèƒ½ã€‚

## ä»€ä¹ˆæ˜¯å›½é™…åŒ–æä¾›è€…ï¼Ÿ

å›½é™…åŒ–æä¾›è€…æ˜¯ä¸€ä¸ªå®ç°äº†ç‰¹å®šæ¥å£çš„å¯¹è±¡ï¼Œå®ƒå®šä¹‰äº†å¦‚ä½•å¤„ç†åº”ç”¨çš„å›½é™…åŒ–éœ€æ±‚ã€‚DVHA é€šè¿‡å›½é™…åŒ–æä¾›è€…æ¥æ‰§è¡Œæ‰€æœ‰çš„å›½é™…åŒ–æ“ä½œï¼ŒåŒ…æ‹¬ï¼š

- **æ–‡æœ¬ç¿»è¯‘** (t)
- **è¯­è¨€åˆ‡æ¢** (changeLocale)
- **è¯­è¨€åŒ…åŠ è½½** (loadLocale)
- **è¯­è¨€åŒ…åˆå¹¶** (mergeLocale)
- **è·å–å½“å‰è¯­è¨€** (getLocale)
- **è·å–æ”¯æŒçš„è¯­è¨€åˆ—è¡¨** (getLocales)

## å†…ç½®å›½é™…åŒ–æä¾›è€…

DVHA å†…ç½®äº† `i18nProvider`ï¼ŒåŸºäº `vue-i18n` å®ç°ï¼š

```typescript
import { i18nProvider } from '@duxweb/dvha-core'

const provider = i18nProvider({
  locale: 'zh-CN',
  fallbackLocale: 'en-US',
  messages: {
    'zh-CN': {
      welcome: 'æ¬¢è¿',
      hello: 'ä½ å¥½ {name}'
    },
    'en-US': {
      welcome: 'Welcome',
      hello: 'Hello {name}'
    }
  }
})

const config: IConfig = {
  i18nProvider: provider,
  // ... å…¶ä»–é…ç½®
}
```

::: tip
å†…ç½®çš„ `i18nProvider` åŸºäºæˆç†Ÿçš„ `vue-i18n` åº“ï¼Œæä¾›å®Œæ•´çš„å›½é™…åŒ–åŠŸèƒ½ï¼ŒåŒ…æ‹¬æ’å€¼ã€å¤æ•°ã€æ—¥æœŸæ—¶é—´æ ¼å¼åŒ–ç­‰ç‰¹æ€§ã€‚å®ƒä½¿ç”¨ Composition API æ¨¡å¼ï¼Œæ”¯æŒ TypeScript ç±»å‹æ¨å¯¼ã€‚
:::

## å›½é™…åŒ–æä¾›è€…æ¥å£

```typescript
interface I18nProvider {
  // ç¿»è¯‘æ–‡æœ¬
  t: (key: string, options?: any, defaultMessage?: string) => string
  // åˆ‡æ¢è¯­è¨€
  changeLocale: (lang: string, options?: any) => Promise<any>
  // åŠ è½½è¯­è¨€åŒ…
  loadLocale: (lang: string, files: Record<string, unknown>) => Promise<any>
  // åˆå¹¶è¯­è¨€åŒ…
  mergeLocale: (lang: string, messages: Record<string, unknown>) => void
  // è·å–å½“å‰è¯­è¨€
  getLocale: () => string
  // è·å–æ”¯æŒçš„è¯­è¨€åˆ—è¡¨
  getLocales: () => string[]
}
```

## é…ç½®é€‰é¡¹

### I18nOptions

åŸºäº `vue-i18n` çš„é…ç½®é€‰é¡¹ï¼š

```typescript
interface I18nOptions {
  locale?: string // é»˜è®¤è¯­è¨€
  fallbackLocale?: string | string[] // å›é€€è¯­è¨€
  messages?: Record<string, any> // è¯­è¨€åŒ…
  legacy?: boolean // æ˜¯å¦ä½¿ç”¨ legacy APIï¼ˆé»˜è®¤ falseï¼‰
  missingWarn?: boolean // ç¼ºå¤±ç¿»è¯‘è­¦å‘Šï¼ˆé»˜è®¤ falseï¼‰
  fallbackWarn?: boolean // å›é€€è­¦å‘Šï¼ˆé»˜è®¤ falseï¼‰
  [key: string]: any // å…¶ä»– vue-i18n é€‰é¡¹
}
```

::: tip é…ç½®è¯´æ˜
å†…ç½®çš„ `i18nProvider` è‡ªåŠ¨è®¾ç½®äº†ä»¥ä¸‹é»˜è®¤å€¼ï¼š
- `legacy: false` - ä½¿ç”¨ Composition API æ¨¡å¼
- `missingWarn: false` - å…³é—­ç¼ºå¤±ç¿»è¯‘è­¦å‘Š
- `fallbackWarn: false` - å…³é—­å›é€€è­¦å‘Š
:::

## ä½¿ç”¨ç¤ºä¾‹

### åŸºæœ¬é…ç½®

```typescript
import { i18nProvider } from '@duxweb/dvha-core'
import enUS from './locales/en-US.json'
import zhCN from './locales/zh-CN.json'

const config: IConfig = {
  i18nProvider: i18nProvider({
    locale: 'zh-CN',
    fallbackLocale: 'en-US',
    messages: {
      'zh-CN': zhCN,
      'en-US': enUS
    }
  }),
  // ... å…¶ä»–é…ç½®
}
```

### è¯­è¨€åŒ…ç»“æ„

æ¨èçš„è¯­è¨€åŒ…ç»“æ„ï¼š

```json
// locales/zh-CN.json
{
  "common": {
    "save": "ä¿å­˜",
    "cancel": "å–æ¶ˆ",
    "confirm": "ç¡®è®¤",
    "delete": "åˆ é™¤"
  },
  "user": {
    "profile": "ç”¨æˆ·èµ„æ–™",
    "name": "å§“å",
    "email": "é‚®ç®±"
  },
  "message": {
    "saveSuccess": "ä¿å­˜æˆåŠŸ",
    "deleteConfirm": "ç¡®å®šè¦åˆ é™¤ {name} å—ï¼Ÿ"
  }
}
```

```json
// locales/en-US.json
{
  "common": {
    "save": "Save",
    "cancel": "Cancel",
    "confirm": "Confirm",
    "delete": "Delete"
  },
  "user": {
    "profile": "User Profile",
    "name": "Name",
    "email": "Email"
  },
  "message": {
    "saveSuccess": "Save successfully",
    "deleteConfirm": "Are you sure to delete {name}?"
  }
}
```

### é«˜çº§é…ç½®

```typescript
import { i18nProvider } from '@duxweb/dvha-core'

const provider = i18nProvider({
  locale: 'zh-CN',
  fallbackLocale: ['en-US', 'zh-CN'],
  messages: {
    'zh-CN': {
      // æ”¯æŒæ’å€¼
      greeting: 'ä½ å¥½ï¼Œ{name}ï¼',
      // æ”¯æŒå¤æ•°
      item: 'æ²¡æœ‰é¡¹ç›® | 1 ä¸ªé¡¹ç›® | {count} ä¸ªé¡¹ç›®',
      // æ”¯æŒåµŒå¥—
      nav: {
        home: 'é¦–é¡µ',
        about: 'å…³äº'
      }
    },
    'en-US': {
      greeting: 'Hello, {name}!',
      item: 'no items | 1 item | {count} items',
      nav: {
        home: 'Home',
        about: 'About'
      }
    }
  }
})
```

### åŠ¨æ€è¯­è¨€åŒ…åŠ è½½

```typescript
import { i18nProvider } from '@duxweb/dvha-core'

const provider = i18nProvider({
  locale: 'zh-CN',
  fallbackLocale: 'en-US',
  messages: {
    'zh-CN': {},
    'en-US': {}
  }
})

// åŠ¨æ€åŠ è½½è¯­è¨€åŒ…
async function loadLanguagePack(lang: string) {
  try {
    const messages = await import(`./locales/${lang}.json`)
    await provider.loadLocale(lang, messages.default)
    await provider.changeLocale(lang)
    console.log(`Language pack loaded: ${lang}`)
  } catch (error) {
    console.error(`Failed to load language pack: ${lang}`, error)
  }
}

// åŠ¨æ€åˆå¹¶è¯­è¨€åŒ…ï¼ˆç”¨äºæ’ä»¶æˆ–æ¨¡å—çš„é¢å¤–ç¿»è¯‘ï¼‰
function mergeModuleTranslations(lang: string, moduleMessages: Record<string, unknown>) {
  provider.mergeLocale(lang, moduleMessages)
}

// ä½¿ç”¨ç¤ºä¾‹
loadLanguagePack('ja-JP')

// åˆå¹¶é¢å¤–çš„ç¿»è¯‘
mergeModuleTranslations('zh-CN', {
  plugin: {
    name: 'æ’ä»¶åç§°',
    settings: 'æ’ä»¶è®¾ç½®'
  }
})
```

### è·å–è¯­è¨€ä¿¡æ¯

```typescript
// è·å–å½“å‰è¯­è¨€
const currentLang = provider.getLocale() // 'zh-CN'

// è·å–æ‰€æœ‰æ”¯æŒçš„è¯­è¨€
const availableLanguages = provider.getLocales() // ['zh-CN', 'en-US']

// æ£€æŸ¥è¯­è¨€æ˜¯å¦æ”¯æŒ
function isLanguageSupported(lang: string): boolean {
  return provider.getLocales().includes(lang)
}
```

## è‡ªå®šä¹‰å›½é™…åŒ–æä¾›è€…

æ‚¨ä¹Ÿå¯ä»¥åˆ›å»ºè‡ªå®šä¹‰çš„å›½é™…åŒ–æä¾›è€…æ¥é€‚é…ç‰¹å®šçš„éœ€æ±‚ï¼š

```typescript
import type { I18nProvider } from '@duxweb/dvha-core'

// åŸºäºå…¶ä»– i18n åº“çš„æä¾›è€…
function customI18nProvider(options: any): I18nProvider {
  // åˆå§‹åŒ–æ‚¨çš„ i18n å®ä¾‹
  const i18n = createYourI18nInstance(options)

  return {
    t: (key: string, options?: any, defaultMessage?: string): string => {
      const result = i18n.translate(key, options)
      return result || defaultMessage || key
    },

    changeLocale: async (lang: string, options?: any): Promise<any> => {
      await i18n.setLocale(lang)
      return lang
    },

    loadLocale: async (lang: string, files: Record<string, unknown>): Promise<any> => {
      i18n.addResourceBundle(lang, 'translation', files)
      return lang
    },

    mergeLocale: (lang: string, messages: Record<string, unknown>): void => {
      i18n.mergeResourceBundle(lang, 'translation', messages)
    },

    getLocale: (): string => {
      return i18n.language
    },

    getLocales: (): string[] => {
      return i18n.languages || []
    }
  }
}
```

## ä¸ç®¡ç†ç«¯é›†æˆ

å›½é™…åŒ–æä¾›è€…å¯ä»¥åœ¨å…¨å±€é…ç½®ï¼Œä¹Ÿå¯ä»¥åœ¨ç‰¹å®šç®¡ç†ç«¯ä¸­é…ç½®ï¼š

```typescript
const config: IConfig = {
  // å…¨å±€å›½é™…åŒ–æä¾›è€…
  i18nProvider: i18nProvider({
    locale: 'zh-CN',
    fallbackLocale: 'en-US',
    messages: globalMessages
  }),

  manages: [
    {
      name: 'admin',
      title: 'ç®¡ç†åå°',
      // ç®¡ç†ç«¯ä¸“ç”¨çš„å›½é™…åŒ–æä¾›è€…
      i18nProvider: i18nProvider({
        locale: 'en-US',
        fallbackLocale: 'zh-CN',
        messages: adminMessages
      })
    },
    {
      name: 'merchant',
      title: 'å•†æˆ·åå°',
      // å•†æˆ·ç«¯ä¸“ç”¨çš„å›½é™…åŒ–æä¾›è€…
      i18nProvider: i18nProvider({
        locale: 'zh-CN',
        fallbackLocale: 'en-US',
        messages: merchantMessages
      })
    }
  ]
}
```

## ä¸ useI18n Hook é›†æˆ

å›½é™…åŒ–æä¾›è€…é€šè¿‡ `useI18n` Hook åœ¨ç»„ä»¶ä¸­ä½¿ç”¨ï¼š

```typescript
import { useI18n } from '@duxweb/dvha-core'

export default {
  setup() {
    const { t, changeLocale, getLocale, loadLocale, mergeLocale, getLocales } = useI18n()

    // åŸºæœ¬ç¿»è¯‘
    const title = t('page.title', null, 'é»˜è®¤æ ‡é¢˜')

    // å¸¦å‚æ•°çš„ç¿»è¯‘
    const greeting = t('welcome.message', { name: 'John' })

    // åˆ‡æ¢è¯­è¨€
    const switchLanguage = async (lang: string) => {
      await changeLocale(lang)
    }

    // åŠ¨æ€åŠ è½½è¯­è¨€åŒ…
    const loadNewLanguage = async (lang: string) => {
      const messages = await import(`./locales/${lang}.json`)
      await loadLocale(lang, messages.default)
      await changeLocale(lang)
    }

    return {
      title,
      greeting,
      switchLanguage,
      loadNewLanguage,
      currentLang: getLocale(),
      availableLanguages: getLocales()
    }
  }
}
```

## æœ€ä½³å®è·µ

### 1. è¯­è¨€åŒ…ç»„ç»‡

```
locales/
â”œâ”€â”€ zh-CN/
â”‚   â”œâ”€â”€ common.json      # é€šç”¨ç¿»è¯‘
â”‚   â”œâ”€â”€ user.json        # ç”¨æˆ·ç›¸å…³
â”‚   â””â”€â”€ admin.json       # ç®¡ç†ç«¯
â”œâ”€â”€ en-US/
â”‚   â”œâ”€â”€ common.json
â”‚   â”œâ”€â”€ user.json
â”‚   â””â”€â”€ admin.json
â””â”€â”€ index.ts             # è¯­è¨€åŒ…å…¥å£
```

### 2. è¯­è¨€åŒ…åˆå¹¶

```typescript
// locales/index.ts
import enUSAdmin from './en-US/admin.json'
import enUSCommon from './en-US/common.json'
import enUSUser from './en-US/user.json'

import zhCNAdmin from './zh-CN/admin.json'
import zhCNCommon from './zh-CN/common.json'
import zhCNUser from './zh-CN/user.json'

export const messages = {
  'zh-CN': {
    ...zhCNCommon,
    ...zhCNUser,
    ...zhCNAdmin
  },
  'en-US': {
    ...enUSCommon,
    ...enUSUser,
    ...enUSAdmin
  }
}
```

### 3. ç±»å‹å®‰å…¨

```typescript
// types/i18n.ts
export interface LocaleMessages {
  common: {
    save: string
    cancel: string
    confirm: string
  }
  user: {
    profile: string
    name: string
    email: string
  }
}

declare module '@duxweb/dvha-core' {
  interface I18nProvider {
    t: <T extends keyof LocaleMessages>(
      key: T,
      options?: any,
      defaultMessage?: string
    ) => string
  }
}
```

### 4. è¯­è¨€åŒ…æ¨¡å—åŒ–

```typescript
// æ¨¡å—åŒ–åŠ è½½è¯­è¨€åŒ…
const loadModuleMessages = async (moduleName: string, lang: string) => {
  try {
    const module = await import(`./modules/${moduleName}/locales/${lang}.json`)
    provider.mergeLocale(lang, {
      [moduleName]: module.default
    })
  } catch (error) {
    console.warn(`Failed to load ${moduleName} messages for ${lang}`)
  }
}

// æ‰¹é‡åŠ è½½æ¨¡å—
const loadAllModuleMessages = async (lang: string) => {
  const modules = ['user', 'product', 'order']
  await Promise.all(
    modules.map(module => loadModuleMessages(module, lang))
  )
}
```

### 5. é»˜è®¤å€¼ç­–ç•¥

```typescript
// æ™ºèƒ½é»˜è®¤å€¼å‡½æ•°
const smartTranslate = (key: string, options?: any, fallback?: string) => {
  // å°è¯•ç¿»è¯‘
  const result = provider.t(key, options)

  // å¦‚æœç¿»è¯‘å¤±è´¥ï¼Œä½¿ç”¨ç­–ç•¥ç”Ÿæˆé»˜è®¤å€¼
  if (result === key) {
    if (fallback) return fallback

    // ä»é”®å€¼ç”Ÿæˆé»˜è®¤å€¼
    const parts = key.split('.')
    const lastPart = parts[parts.length - 1]
    return lastPart.charAt(0).toUpperCase() + lastPart.slice(1)
  }

  return result
}
```

## æ€§èƒ½ä¼˜åŒ–

### 1. æŒ‰éœ€åŠ è½½è¯­è¨€åŒ…

```typescript
const lazyLoadLanguagePack = async (lang: string) => {
  // æ£€æŸ¥æ˜¯å¦å·²ç»åŠ è½½
  if (provider.getLocales().includes(lang)) {
    return provider.changeLocale(lang)
  }

  // åŠ¨æ€å¯¼å…¥è¯­è¨€åŒ…
  const [common, specific] = await Promise.all([
    import(`./locales/common/${lang}.json`),
    import(`./locales/specific/${lang}.json`)
  ])

  // åˆå¹¶å¹¶åŠ è½½
  const merged = { ...common.default, ...specific.default }
  await provider.loadLocale(lang, merged)
  return provider.changeLocale(lang)
}
```

### 2. ç¿»è¯‘ç¼“å­˜

```typescript
// åˆ›å»ºç¿»è¯‘ç¼“å­˜
const translationCache = new Map<string, string>()

const cachedTranslate = (key: string, options?: any, defaultMessage?: string) => {
  const cacheKey = `${key}:${JSON.stringify(options)}`

  if (translationCache.has(cacheKey)) {
    return translationCache.get(cacheKey)!
  }

  const result = provider.t(key, options, defaultMessage)
  translationCache.set(cacheKey, result)

  return result
}

// æ¸…ç†ç¼“å­˜ï¼ˆè¯­è¨€åˆ‡æ¢æ—¶ï¼‰
const clearTranslationCache = () => {
  translationCache.clear()
}
```

::: tip å°æç¤º

- ä½¿ç”¨å‘½åç©ºé—´æ¥ç»„ç»‡ç¿»è¯‘é”®å€¼ï¼Œé¿å…å†²çª
- ä¸ºå¸¸ç”¨çš„ç¿»è¯‘æ–‡æœ¬æä¾›é»˜è®¤å€¼
- å®šæœŸæ£€æŸ¥å’Œæ¸…ç†æœªä½¿ç”¨çš„ç¿»è¯‘é”®å€¼
- è€ƒè™‘ä½¿ç”¨å·¥å…·æ¥è‡ªåŠ¨åŒ–ç¿»è¯‘æµç¨‹
- åˆ©ç”¨ `mergeLocale` æ–¹æ³•å®ç°æ’ä»¶åŒ–çš„ç¿»è¯‘æ‰©å±•
- ä½¿ç”¨ `getLocales` æ–¹æ³•åŠ¨æ€æ„å»ºè¯­è¨€åˆ‡æ¢å™¨
:::

## ä¸‹ä¸€æ­¥

äº†è§£å¦‚ä½•åœ¨ç»„ä»¶ä¸­ä½¿ç”¨å›½é™…åŒ–åŠŸèƒ½ï¼š

- ğŸŒ [å›½é™…åŒ– Hook (useI18n)](/hooks/system/useI18n) - åœ¨ç»„ä»¶ä¸­ä½¿ç”¨å›½é™…åŒ–åŠŸèƒ½
